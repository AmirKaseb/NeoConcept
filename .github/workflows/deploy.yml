name: üöÄ Deploy NeoConcept

on:
  push:
    branches: [ devops ]
  workflow_dispatch:

env:
  AWS_REGION: eu-west-3

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
    
    - name: Terraform Apply
      working-directory: ./devops
      run: |
        terraform init
        # Try to import existing resources if they exist
        terraform import aws_iam_role.ec2_role neoconcept-ec2-role 2>/dev/null || echo "IAM role not found, will create new one"
        terraform import aws_iam_instance_profile.ec2_profile neoconcept-ec2-profile 2>/dev/null || echo "Instance profile not found, will create new one"
        terraform apply -auto-approve
    
    - name: Deploy Application via SSH
      run: |
        INSTANCE_ID=$(cd devops && terraform output -raw instance_id)
        INSTANCE_IP=$(cd devops && terraform output -raw instance_public_ip)
        echo "Deploying to instance: $INSTANCE_ID at IP: $INSTANCE_IP"
        
        # Wait for instance to be ready
        aws ec2 wait instance-running --instance-ids $INSTANCE_ID
        echo "Instance is running, waiting for SSH..."
        sleep 60
        
        # Deploy via SSH using AWS Systems Manager
        aws ssm send-command \
          --instance-ids $INSTANCE_ID \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "cd /opt/neoconcept",
            "rm -rf NeoConcept || true",
            "git clone -b devops https://github.com/${{ github.repository }}.git NeoConcept",
            "cd NeoConcept",
            "cd devops",
            "docker-compose down || true",
            "docker-compose up --build -d"
          ]' \
          --comment "Deploy NeoConcept Application"
        
        echo "Deployment command sent. Application should be starting..."
        sleep 30
    
    - name: Get IP
      working-directory: ./devops
      run: |
        echo "üéâ Deployment complete!"
        echo "üåê Your app: $(terraform output -raw application_url)"
        echo "üìç IP: $(terraform output -raw instance_public_ip)"