name: ğŸš€ Deploy NeoConcept

on:
  push:
    branches: [ devops ]
  workflow_dispatch:

env:
  AWS_REGION: eu-west-3

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
    
    - name: Create S3 Bucket for State (if needed)
      run: |
        # Check if bucket exists, create if not
        if ! aws s3 ls s3://neoconcept-terraform-state 2>/dev/null; then
          echo "Creating S3 bucket for Terraform state..."
          aws s3 mb s3://neoconcept-terraform-state --region eu-west-3
          aws s3api put-bucket-versioning --bucket neoconcept-terraform-state --versioning-configuration Status=Enabled
          aws s3api put-bucket-encryption --bucket neoconcept-terraform-state --server-side-encryption-configuration '{
            "Rules": [{"ApplyServerSideEncryptionByDefault": {"SSEAlgorithm": "AES256"}}]
          }'
          echo "âœ… S3 bucket created successfully"
        else
          echo "âœ… S3 bucket already exists"
        fi

    - name: Terraform Apply
      working-directory: ./devops
      run: |
        terraform init
        # Try to import existing resources if they exist
        terraform import aws_iam_role.ec2_role neoconcept-ec2-role 2>/dev/null || echo "IAM role not found, will create new one"
        terraform import aws_iam_instance_profile.ec2_profile neoconcept-ec2-profile 2>/dev/null || echo "Instance profile not found, will create new one"
        
        # Try to import existing EC2 instance
        EXISTING_INSTANCE_ID=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=neoconcept-server" "Name=instance-state-name,Values=running" --query 'Reservations[0].Instances[0].InstanceId' --output text 2>/dev/null || echo "")
        if [ ! -z "$EXISTING_INSTANCE_ID" ] && [ "$EXISTING_INSTANCE_ID" != "None" ]; then
          echo "Found existing instance: $EXISTING_INSTANCE_ID, importing..."
          terraform import aws_instance.neoconcept_server $EXISTING_INSTANCE_ID || echo "Instance import failed, will create new one"
        else
          echo "No existing instance found, will create new one"
        fi
        
        # Debug: Check if SSH public key secret is available
        if [ -z "${{ secrets.SSH_PUBLIC_KEY }}" ]; then
          echo "âŒ SSH_PUBLIC_KEY secret is not set!"
          exit 1
        else
          echo "âœ… SSH_PUBLIC_KEY secret is available (length: ${#SSH_PUBLIC_KEY})"
        fi
        
        terraform apply -auto-approve -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" -input=false
    
    - name: Deploy Application via SSH
      run: |
        INSTANCE_ID=$(cd devops && terraform output -raw instance_id)
        INSTANCE_IP=$(cd devops && terraform output -raw instance_public_ip)
        echo "Deploying to instance: $INSTANCE_ID at IP: $INSTANCE_IP"
        
        # Wait for instance to be ready
        aws ec2 wait instance-running --instance-ids $INSTANCE_ID
        echo "Instance is running, waiting for SSH..."
        sleep 60
        
        # Save SSH private key from GitHub Secrets
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > /tmp/neoconcept_key
        chmod 600 /tmp/neoconcept_key
        
        # Deploy via SSH with private key
        echo "Deploying application via SSH..."
        ssh -i /tmp/neoconcept_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@$INSTANCE_IP "
          cd /opt/neoconcept &&
          rm -rf NeoConcept || true &&
          git clone -b devops https://github.com/${{ github.repository }}.git NeoConcept &&
          cd NeoConcept/devops &&
          docker-compose down || true &&
          docker-compose up --build -d &&
          echo 'âœ… Deployment completed!'
        "
        
        echo "ğŸ‰ Application deployed successfully!"
    
    - name: Get IP
      working-directory: ./devops
      run: |
        echo "ğŸ‰ Deployment complete!"
        echo "ğŸŒ Your app: $(terraform output -raw application_url)"
        echo "ğŸ“ IP: $(terraform output -raw instance_public_ip)"